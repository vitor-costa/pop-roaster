Disclaimer: the initial code is not mine, but I don't know the ownership of everything